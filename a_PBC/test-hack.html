<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partisia Wallet Security Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .warning {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Partisia Wallet Security Test (MAINNET)</h1>
    <p class="warning">⚠️ This is a security test page to verify if the Partisia Wallet connects automatically without user consent on mainnet.</p>
    
    <div class="container">
        <h2>Test Results</h2>
        <p>Wallet Extension Detected: <span id="wallet-detected">Checking...</span></p>
        <p>Auto-Connection Attempted: <span id="auto-connection">Not yet</span></p>
        <p>Connection Result: <span id="connection-result">Not yet</span></p>
        <p>Wallet Address: <span id="wallet-address">None</span></p>
        <p>Connection Prompt Shown: <span id="prompt-shown">Unknown</span></p>
        
        <button id="manual-connect">Manually Connect Wallet</button>
        <button id="check-connection">Check Connection Status</button>
        <button id="disconnect">Disconnect Wallet</button>
    </div>
    
    <div class="container">
        <h2>Connection Log</h2>
        <pre id="connection-log">Test started at: <span id="start-time"></span></pre>
    </div>

    <script>
        // Set start time
        document.getElementById('start-time').textContent = new Date().toLocaleTimeString();
        
        // Log function
        function log(message) {
            const logElement = document.getElementById('connection-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `\n[${timestamp}] ${message}`;
        }

        // Check if wallet is available
        function checkWalletAvailability() {
            const walletDetectedElement = document.getElementById('wallet-detected');
            
            if (typeof window.partisiawallet !== 'undefined') {
                walletDetectedElement.textContent = 'Yes';
                walletDetectedElement.className = 'success';
                log('Partisia Wallet extension detected');
                return true;
            } else {
                walletDetectedElement.textContent = 'No';
                walletDetectedElement.className = 'warning';
                log('Partisia Wallet extension NOT detected');
                return false;
            }
        }

        // Try auto-connection
        async function tryAutoConnect() {
            const autoConnectionElement = document.getElementById('auto-connection');
            const connectionResultElement = document.getElementById('connection-result');
            const promptShownElement = document.getElementById('prompt-shown');
            
            autoConnectionElement.textContent = 'Attempted';
            log('Attempting automatic connection...');
            
            try {
                // Check if already connected
                try {
                    const address = await window.partisiawallet.getAddress();
                    if (address) {
                        document.getElementById('wallet-address').textContent = address;
                        connectionResultElement.textContent = 'Already Connected';
                        connectionResultElement.className = 'warning';
                        log('Wallet was already connected! Address: ' + address);
                        promptShownElement.textContent = 'No (Already Connected)';
                        return;
                    }
                } catch (e) {
                    log('Not already connected: ' + e.message);
                }
                
                // Try to connect
                log('Calling connect() method...');
                promptShownElement.textContent = 'Waiting to see...';
                
                // Set a timeout to check if we think a prompt was shown
                setTimeout(() => {
                    promptShownElement.textContent = 'Likely No (No delay observed)';
                    log('No significant delay observed, prompt likely not shown');
                }, 500);
                
                const result = await window.partisiawallet.connect({
                    name: 'Security Test',
                    description: 'Testing wallet auto-connection vulnerability',
                    url: window.location.origin,
                });
                
                log('Connection result: ' + JSON.stringify(result));
                connectionResultElement.textContent = 'Connected';
                connectionResultElement.className = 'warning';
                
                // Get address
                const address = await window.partisiawallet.getAddress();
                document.getElementById('wallet-address').textContent = address;
                log('Connected to wallet address: ' + address);
                
            } catch (error) {
                connectionResultElement.textContent = 'Failed: ' + error.message;
                connectionResultElement.className = 'warning';
                log('Connection failed: ' + error.message);
            }
        }

        // Manual connect
        async function manualConnect() {
            log('Manual connection requested by user');
            
            try {
                const result = await window.partisiawallet.connect({
                    name: 'Security Test (Manual)',
                    description: 'Testing wallet connection with manual trigger',
                    url: window.location.origin,
                });
                
                log('Manual connection result: ' + JSON.stringify(result));
                document.getElementById('connection-result').textContent = 'Connected (Manual)';
                document.getElementById('connection-result').className = 'success';
                
                // Get address
                const address = await window.partisiawallet.getAddress();
                document.getElementById('wallet-address').textContent = address;
                log('Connected to wallet address: ' + address);
                
            } catch (error) {
                log('Manual connection failed: ' + error.message);
            }
        }

        // Check connection status
        async function checkConnection() {
            log('Checking current connection status');
            
            try {
                const address = await window.partisiawallet.getAddress();
                document.getElementById('wallet-address').textContent = address;
                document.getElementById('connection-result').textContent = 'Connected';
                document.getElementById('connection-result').className = 'success';
                log('Currently connected to wallet address: ' + address);
            } catch (error) {
                document.getElementById('connection-result').textContent = 'Not Connected';
                document.getElementById('wallet-address').textContent = 'None';
                log('Not currently connected: ' + error.message);
            }
        }

        // Disconnect wallet
        async function disconnect() {
            log('Attempting to disconnect wallet');
            
            try {
                await window.partisiawallet.disconnect();
                document.getElementById('connection-result').textContent = 'Disconnected';
                document.getElementById('wallet-address').textContent = 'None';
                log('Wallet disconnected successfully');
            } catch (error) {
                log('Disconnect failed: ' + error.message);
            }
        }

        // Run initial check
        window.addEventListener('DOMContentLoaded', () => {
            if (checkWalletAvailability()) {
                // Wait a moment before trying auto-connect
                setTimeout(tryAutoConnect, 1000);
            }
        });

        // Set up button event listeners
        document.getElementById('manual-connect').addEventListener('click', manualConnect);
        document.getElementById('check-connection').addEventListener('click', checkConnection);
        document.getElementById('disconnect').addEventListener('click', disconnect);
    </script>
</body>
</html>
