<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partisia Wallet Detection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status-box {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Partisia Wallet Detection Test</h1>
    
    <div class="status-box">
        <h2>Wallet Status</h2>
        <p>Detection Method 1 (window.partisiawallet): <span id="method1">Checking...</span></p>
        <p>Detection Method 2 (window.ethereum?.isPartisia): <span id="method2">Checking...</span></p>
        <p>Detection Method 3 (after 3s delay): <span id="method3">Waiting...</span></p>
        <p>Connected Address: <span id="address">None</span></p>
    </div>
    
    <div>
        <button id="check-btn">Check Again</button>
        <button id="connect-btn">Connect</button>
        <button id="refresh-btn">Refresh Page</button>
    </div>
    
    <div class="status-box">
        <h2>Debug Information</h2>
        <pre id="debug">Initializing...</pre>
    </div>
    
    <script>
        // Elements
        const method1El = document.getElementById('method1');
        const method2El = document.getElementById('method2');
        const method3El = document.getElementById('method3');
        const addressEl = document.getElementById('address');
        const debugEl = document.getElementById('debug');
        
        // Log function
        function log(message) {
            const time = new Date().toLocaleTimeString();
            debugEl.textContent += `\n[${time}] ${message}`;
            // Auto-scroll
            debugEl.scrollTop = debugEl.scrollHeight;
        }
        
        // Check for wallet using different methods
        function checkWallet() {
            log('Checking wallet availability...');
            
            // Method 1: Direct window.partisiawallet check
            if (typeof window.partisiawallet !== 'undefined') {
                method1El.textContent = 'Available';
                method1El.className = 'success';
                log('✅ Method 1: window.partisiawallet is available');
            } else {
                method1El.textContent = 'Not Available';
                method1El.className = 'error';
                log('❌ Method 1: window.partisiawallet is NOT available');
            }
            
            // Method 2: Check for ethereum.isPartisia
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isPartisia) {
                method2El.textContent = 'Available';
                method2El.className = 'success';
                log('✅ Method 2: window.ethereum.isPartisia is available');
            } else {
                method2El.textContent = 'Not Available';
                method2El.className = 'error';
                log('❌ Method 2: window.ethereum.isPartisia is NOT available');
                
                // Log what is available
                if (typeof window.ethereum !== 'undefined') {
                    log('window.ethereum exists but isPartisia is not true');
                    log(`ethereum properties: ${Object.keys(window.ethereum).join(', ')}`);
                } else {
                    log('window.ethereum does NOT exist');
                }
            }
            
            // Log all global properties that might be related
            log('Checking for any wallet-related global properties:');
            const walletRelatedProps = ['partisiawallet', 'ethereum', 'web3', 'partisia', 'pbc'];
            for (const prop of walletRelatedProps) {
                if (window[prop]) {
                    log(`✅ window.${prop} exists`);
                } else {
                    log(`❌ window.${prop} does NOT exist`);
                }
            }
        }
        
        // Try to connect to wallet
        async function connectWallet() {
            log('Attempting to connect to wallet...');
            
            // Try multiple methods
            if (typeof window.partisiawallet !== 'undefined') {
                log('Using window.partisiawallet.connect()');
                try {
                    const result = await window.partisiawallet.connect({
                        name: 'PartiVotes Test',
                        description: 'Testing wallet connection',
                        url: window.location.origin
                    });
                    
                    log(`✅ Connection successful: ${JSON.stringify(result)}`);
                    
                    try {
                        const address = await window.partisiawallet.getAddress();
                        addressEl.textContent = address;
                        log(`✅ Address: ${address}`);
                    } catch (e) {
                        log(`❌ Failed to get address: ${e.message}`);
                    }
                } catch (e) {
                    log(`❌ Connection failed: ${e.message}`);
                }
            } else if (typeof window.ethereum !== 'undefined' && window.ethereum.isPartisia) {
                log('Using window.ethereum methods (Partisia)');
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    log(`✅ Accounts: ${accounts.join(', ')}`);
                    if (accounts.length > 0) {
                        addressEl.textContent = accounts[0];
                    }
                } catch (e) {
                    log(`❌ Connection failed: ${e.message}`);
                }
            } else {
                log('❌ No wallet methods available to connect');
            }
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            log('Page loaded');
            checkWallet();
            
            // Set timeout for delayed check (Method 3)
            setTimeout(() => {
                log('Performing delayed check (3 seconds)...');
                
                if (typeof window.partisiawallet !== 'undefined') {
                    method3El.textContent = 'Available';
                    method3El.className = 'success';
                    log('✅ Method 3: window.partisiawallet is available after delay');
                    
                    // Auto-connect attempt
                    log('Auto-attempting to connect after delay...');
                    window.partisiawallet.connect({
                        name: 'PartiVotes Test',
                        description: 'Testing wallet auto-connection',
                        url: window.location.origin
                    }).then(result => {
                        log(`✅ Auto-connection successful: ${JSON.stringify(result)}`);
                        return window.partisiawallet.getAddress();
                    }).then(address => {
                        addressEl.textContent = address;
                        log(`✅ Auto-connected address: ${address}`);
                    }).catch(e => {
                        log(`❌ Auto-connection failed: ${e.message}`);
                    });
                } else {
                    method3El.textContent = 'Not Available';
                    method3El.className = 'error';
                    log('❌ Method 3: window.partisiawallet is NOT available after delay');
                }
            }, 3000);
        });
        
        // Button event listeners
        document.getElementById('check-btn').addEventListener('click', checkWallet);
        document.getElementById('connect-btn').addEventListener('click', connectWallet);
        document.getElementById('refresh-btn').addEventListener('click', () => window.location.reload());
    </script>
</body>
</html>
