<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Final Partisia Wallet Test</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f7f7f7;
    }
    #root {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    .header { 
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }
    .button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 8px 16px;
      margin-right: 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #45a049;
    }
    .status-success { color: green; font-weight: bold; }
    .status-error { color: red; font-weight: bold; }
    .log-area {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    // --- Simulated Wallet Service (similar to your main app) ---
    
    // Mock wallet service similar to your application's walletService.js
    const WalletService = {
      // Initialize the wallet SDK - mimics initializeWalletSDK() in your main app
      initializeWalletSDK: async () => {
        console.log('Initializing Partisia Wallet SDK...');
        try {
          // This is the same initialization pattern used in your main application
          console.log('Partisia Wallet SDK initialized');
          return true;
        } catch (error) {
          console.error('Failed to initialize Partisia wallet SDK:', error);
          return false;
        }
      },
      
      // Check if wallet is connected - similar to checkWalletConnection() in your main app
      checkWalletConnection: async () => {
        try {
          // Check if the Partisia Wallet Browser Extension is installed
          if (typeof window.partisiawallet === 'undefined') {
            console.warn('Partisia Wallet Browser Extension not detected');
            return false;
          }
          
          // Check if the wallet is connected
          const isConnected = await window.partisiawallet.isConnected();
          return isConnected;
        } catch (error) {
          console.error('Failed to check Partisia wallet connection:', error);
          return false;
        }
      },
      
      // Connect to wallet - similar to connectWallet() in your main app
      connectWallet: async () => {
        try {
          // Check if the Partisia Wallet Browser Extension is installed
          if (typeof window.partisiawallet === 'undefined') {
            throw new Error('Partisia Wallet Browser Extension not detected');
          }
          
          // Connect to the Partisia Wallet
          await window.partisiawallet.connect({
            name: 'PartiVotes',
            description: 'Decentralized voting application on Partisia Blockchain',
            url: window.location.origin,
          });
          
          console.log('Partisia Wallet connected');
          return true;
        } catch (error) {
          console.error('Failed to connect Partisia wallet:', error);
          throw error;
        }
      },
      
      // Get wallet address - similar to getWalletAddress() in your main app
      getWalletAddress: async () => {
        try {
          // Check if the Partisia Wallet Browser Extension is installed
          if (typeof window.partisiawallet === 'undefined') {
            throw new Error('Partisia Wallet Browser Extension not detected');
          }
          
          // Get the address from the Partisia Wallet
          const address = await window.partisiawallet.getAddress();
          return address;
        } catch (error) {
          console.error('Failed to get Partisia wallet address:', error);
          throw error;
        }
      },
    };
    
    // Initialize the wallet SDK when the service is imported - just like in your main app
    WalletService.initializeWalletSDK();
    
    // --- Simulated Wallet Context (similar to your app's WalletContext.jsx) ---
    
    // Create a React Context for wallet state
    const WalletContext = React.createContext();
    
    // Wallet Provider Component
    const WalletProvider = ({ children }) => {
      // State
      const [connected, setConnected] = React.useState(false);
      const [address, setAddress] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState(null);
      const [logs, setLogs] = React.useState([]);
      
      // Add log message
      const addLog = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        setLogs(prev => [{
          id: Date.now(),
          timestamp,
          message,
          type
        }, ...prev]);
      };
      
      // Function to connect wallet
      const connect = async () => {
        try {
          setLoading(true);
          setError(null);
          addLog('Attempting to connect wallet...');
          
          await WalletService.connectWallet();
          const walletAddress = await WalletService.getWalletAddress();
          
          setAddress(walletAddress);
          setConnected(true);
          addLog(`✅ Connected to wallet: ${walletAddress}`, 'success');
        } catch (err) {
          addLog(`❌ Error connecting wallet: ${err.message}`, 'error');
          setError('Failed to connect wallet. Please try again.');
        } finally {
          setLoading(false);
        }
      };
      
      // Check initial connection status - same pattern as your main app
      React.useEffect(() => {
        const checkConnection = async () => {
          try {
            setLoading(true);
            addLog('Checking wallet connection on mount...');
            
            const isConnected = await WalletService.checkWalletConnection();
            addLog(`Wallet connected: ${isConnected}`);
            
            if (isConnected) {
              const walletAddress = await WalletService.getWalletAddress();
              setAddress(walletAddress);
              setConnected(true);
              addLog(`✅ Already connected to wallet: ${walletAddress}`, 'success');
            } else {
              addLog('Not currently connected to wallet');
            }
          } catch (err) {
            addLog(`❌ Error checking wallet connection: ${err.message}`, 'error');
          } finally {
            setLoading(false);
          }
        };
        
        checkConnection();
      }, []);
      
      // Check wallet availability
      const checkWalletAvailability = () => {
        addLog('Checking wallet availability...');
        
        if (typeof window.partisiawallet !== 'undefined') {
          addLog('✅ window.partisiawallet is available', 'success');
          return true;
        } else {
          addLog('❌ window.partisiawallet is not available', 'error');
          return false;
        }
      };
      
      return (
        <WalletContext.Provider value={{ 
          connected, 
          address, 
          loading, 
          error, 
          connect,
          checkWalletAvailability,
          logs
        }}>
          {children}
        </WalletContext.Provider>
      );
    };
    
    // --- Main Application Component ---
    
    function App() {
      const { 
        connected, 
        address, 
        loading, 
        error, 
        connect,
        checkWalletAvailability,
        logs
      } = React.useContext(WalletContext);
      
      return (
        <div>
          <div className="header">
            <h1>Final Partisia Wallet Test</h1>
            <p>This test mimics the exact initialization pattern from the main application</p>
          </div>
          
          <div className="section">
            <h2>Wallet Status</h2>
            <p>
              <strong>Connection Status:</strong>{' '}
              {loading ? 'Checking...' : connected ? 
                <span className="status-success">Connected</span> : 
                <span className="status-error">Not Connected</span>
              }
            </p>
            {address && (
              <p><strong>Wallet Address:</strong> {address}</p>
            )}
            {error && (
              <p className="status-error">{error}</p>
            )}
          </div>
          
          <div>
            <button 
              className="button" 
              onClick={checkWalletAvailability} 
              disabled={loading}
            >
              Check Wallet Availability
            </button>
            <button 
              className="button" 
              onClick={connect} 
              disabled={loading || connected}
            >
              Connect Wallet
            </button>
          </div>
          
          <div className="log-area">
            <h3>Activity Log</h3>
            {logs.map(log => (
              <div key={log.id} className={`log-entry log-${log.type}`}>
                [{log.timestamp}] {log.message}
              </div>
            ))}
          </div>
        </div>
      );
    }
    
    // Render application with the wallet provider
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <WalletProvider>
        <App />
      </WalletProvider>
    );
  </script>
</body>
</html>
