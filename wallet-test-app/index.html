<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partisia Wallet Test App</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    #root {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    .header {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .status-card {
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      background-color: #f7f7f7;
    }
    .button {
      padding: 8px 16px;
      margin-right: 8px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #45a049;
    }
    .log-container {
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      margin-top: 20px;
    }
    .success {
      color: green;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // React components
    const WalletTest = () => {
      const [walletStatus, setWalletStatus] = React.useState({
        directDetection: null,
        ethereumDetection: null,
        isPartisia: null,
        address: null,
        connected: false,
        loading: false
      });
      
      const [logs, setLogs] = React.useState([]);
      
      // Log function
      const addLog = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        setLogs(prevLogs => [
          { id: Date.now(), timestamp, message, type },
          ...prevLogs
        ]);
      };
      
      // Check wallet availability
      const checkWallet = React.useCallback(() => {
        addLog('Checking wallet availability...');
        setWalletStatus(prev => ({ ...prev, loading: true }));
        
        // Direct detection
        const directDetection = typeof window.partisiawallet !== 'undefined';
        addLog(
          directDetection 
            ? '✅ window.partisiawallet exists' 
            : '❌ window.partisiawallet does not exist',
          directDetection ? 'success' : 'error'
        );
        
        // Ethereum detection
        const ethereumDetection = typeof window.ethereum !== 'undefined';
        addLog(
          ethereumDetection 
            ? '✅ window.ethereum exists' 
            : '❌ window.ethereum does not exist',
          ethereumDetection ? 'success' : 'error'
        );
        
        // Is Partisia check
        let isPartisia = false;
        if (ethereumDetection) {
          isPartisia = !!window.ethereum?.isPartisia;
          addLog(
            isPartisia 
              ? '✅ window.ethereum.isPartisia is true' 
              : '❌ window.ethereum.isPartisia is false or undefined',
            isPartisia ? 'success' : 'error'
          );
        }
        
        setWalletStatus({
          directDetection,
          ethereumDetection,
          isPartisia,
          address: null,
          connected: false,
          loading: false
        });
        
        addLog('Wallet check complete');
        
        return directDetection;
      }, []);
      
      // Connect wallet
      const connectWallet = async () => {
        if (!walletStatus.directDetection) {
          addLog('❌ Cannot connect - Partisia Wallet not detected', 'error');
          return;
        }
        
        setWalletStatus(prev => ({ ...prev, loading: true }));
        addLog('Attempting to connect to Partisia Wallet...');
        
        try {
          await window.partisiawallet.connect({
            name: 'PartiVotes Wallet Test',
            description: 'Test application for Partisia Wallet',
            url: window.location.origin,
          });
          
          addLog('✅ Successfully connected to wallet', 'success');
          
          try {
            const address = await window.partisiawallet.getAddress();
            addLog(`✅ Wallet address: ${address}`, 'success');
            
            setWalletStatus(prev => ({
              ...prev,
              address,
              connected: true,
              loading: false
            }));
          } catch (error) {
            addLog(`❌ Failed to get address: ${error.message}`, 'error');
            setWalletStatus(prev => ({ ...prev, loading: false }));
          }
        } catch (error) {
          addLog(`❌ Connection failed: ${error.message}`, 'error');
          setWalletStatus(prev => ({ ...prev, loading: false }));
        }
      };
      
      // Disconnect wallet
      const disconnectWallet = async () => {
        if (!walletStatus.directDetection) {
          addLog('❌ Cannot disconnect - Partisia Wallet not detected', 'error');
          return;
        }
        
        setWalletStatus(prev => ({ ...prev, loading: true }));
        addLog('Attempting to disconnect from Partisia Wallet...');
        
        try {
          await window.partisiawallet.disconnect();
          addLog('✅ Successfully disconnected from wallet', 'success');
          
          setWalletStatus(prev => ({
            ...prev,
            address: null,
            connected: false,
            loading: false
          }));
        } catch (error) {
          addLog(`❌ Disconnect failed: ${error.message}`, 'error');
          setWalletStatus(prev => ({ ...prev, loading: false }));
        }
      };
      
      // Check wallet on mount with a delay to ensure the wallet has time to inject
      React.useEffect(() => {
        // Check immediately
        addLog('Initial wallet check...');
        const initialCheck = checkWallet();
        
        // Check again after 1 second to give the wallet time to inject
        const timerId = setTimeout(() => {
          addLog('Delayed wallet check (after 1 second)...');
          checkWallet();
        }, 1000);
        
        // Check again after 3 seconds
        const timerIdLong = setTimeout(() => {
          addLog('Delayed wallet check (after 3 seconds)...');
          checkWallet();
        }, 3000);
        
        return () => {
          clearTimeout(timerId);
          clearTimeout(timerIdLong);
        };
      }, [checkWallet]);
      
      return (
        <div>
          <div className="header">
            <h1>Partisia Wallet Test App</h1>
            <p>This is an isolated React app to test wallet detection and connection</p>
          </div>
          
          <div className="status-card">
            <h2>Wallet Status</h2>
            <p>
              <strong>Detection (direct):</strong>{' '}
              {walletStatus.directDetection === null ? 'Checking...' : 
                walletStatus.directDetection ? 
                  <span className="success">Available</span> : 
                  <span className="error">Not Available</span>
              }
            </p>
            <p>
              <strong>Detection (ethereum):</strong>{' '}
              {walletStatus.ethereumDetection === null ? 'Checking...' : 
                walletStatus.ethereumDetection ? 
                  <span className="success">Available</span> : 
                  <span className="error">Not Available</span>
              }
            </p>
            {walletStatus.ethereumDetection && (
              <p>
                <strong>isPartisia:</strong>{' '}
                {walletStatus.isPartisia ? 
                  <span className="success">True</span> : 
                  <span className="error">False</span>
                }
              </p>
            )}
            <p>
              <strong>Connection:</strong>{' '}
              {walletStatus.connected ? 
                <span className="success">Connected</span> : 
                <span className="error">Not Connected</span>
              }
            </p>
            {walletStatus.address && (
              <p>
                <strong>Address:</strong> {walletStatus.address}
              </p>
            )}
          </div>
          
          <div>
            <button 
              className="button" 
              onClick={checkWallet} 
              disabled={walletStatus.loading}
            >
              Check Wallet
            </button>
            <button 
              className="button" 
              onClick={connectWallet} 
              disabled={!walletStatus.directDetection || walletStatus.loading}
            >
              Connect Wallet
            </button>
            <button 
              className="button" 
              onClick={disconnectWallet} 
              disabled={!walletStatus.connected || walletStatus.loading}
            >
              Disconnect Wallet
            </button>
          </div>
          
          <div className="log-container">
            <h3>Logs</h3>
            {logs.map(log => (
              <div key={log.id} className={log.type}>
                [{log.timestamp}] {log.message}
              </div>
            ))}
          </div>
        </div>
      );
    };
    
    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<WalletTest />);
  </script>
</body>
</html>
